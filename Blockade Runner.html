<!DOCTYPE html>
<!--

Blockade Runner
Christofer Padilla
CAP 4720

-->
<html>

<head>
	<title>~=BLOCADE RUNNER=~</title>

	<link rel="stylesheet" type="text/css" href="css/styles.css" />

	<script type="text/javascript" src="js/three.min.js"></script>
	<script type="text/javascript" src="js/stats.js"></script>
	<script type="text/javascript" src="js/physi.js"></script>
	<script type="text/javascript" src="js/buzz.js"></script>

	<script type="text/javascript">

	'use strict';

	Physijs.scripts.worker = 'js/physijs_worker.js';
	Physijs.scripts.ammo = 'ammo.js';
	Physijs.scripts.buzz = 'js/buzz.js';

	var initScene, render, _boxes = [], spawnBox, spawnPlayer, loader, Update, time,
		renderer, render_stats, physics_stats, scene, ground_material, ground, light,
		camera, onMouseMove, start, loadSounds, createGround, createButton;

	var player, playerSpeed, playerStartZ, GAMESTATE, spawnInterval, mouseX, mouseY,
	rampTime, gameSpeed;

	var raycaster = new THREE.Raycaster();
	var mouse = new THREE.Vector2();

	var explode, music, gameover, gameover_noise;

	var windowHalfX = window.innerWidth / 2;
	var windowHalfY = window.innerHeight / 2;

	start = function() {
		// initialize variables
		time = 0;
		spawnInterval = 1;
		playerSpeed = .0005;
		playerStartZ = 25;
		mouseX = 0;
		mouseY = 0;
		rampTime = 700;
		gameSpeed = 1;

		GAMESTATE = "PLAY";
		music.play();
		music.loop = true;
	};

	initScene = function() {
		renderer = new THREE.WebGLRenderer({ antialias: true });
		renderer.setSize( window.innerWidth, window.innerHeight );
		renderer.shadowMap.enabled = true;
		renderer.shadowMapSoft = true;
		document.getElementById( 'viewport' ).appendChild( renderer.domElement );

		render_stats = new Stats();
		render_stats.domElement.style.position = 'absolute';
		render_stats.domElement.style.top = '0px';
		render_stats.domElement.style.right = '80px';
		render_stats.domElement.style.zIndex = 100;
		document.getElementById( 'viewport' ).appendChild( render_stats.domElement );

		physics_stats = new Stats();
		physics_stats.domElement.style.position = 'absolute';
		physics_stats.domElement.style.top = '0px';
		physics_stats.domElement.style.right = '0px';
		physics_stats.domElement.style.zIndex = 100;
		document.getElementById( 'viewport' ).appendChild( physics_stats.domElement );

		document.addEventListener( 'mousemove', onMouseMove );

		scene = new Physijs.Scene;
		scene.setGravity(new THREE.Vector3( 0, -30, 0 ));
		scene.addEventListener(
			'update',
			function() {
				Update();
				scene.simulate( undefined, 1 );
				physics_stats.update();
			}
		);

		camera = new THREE.PerspectiveCamera(
			35,
			window.innerWidth / window.innerHeight,
			1,
			1000
		);
		camera.position.set( 0, 50, 90 );
		camera.lookAt( scene.position );
		scene.add( camera );

		// Light
		light = new THREE.DirectionalLight( 0xFFFFFF );
		light.position.set( 20, 40, -15 );
		light.target.position.copy( scene.position );
		light.castShadow = true;
		light.shadowCameraLeft = -60;
		light.shadowCameraTop = -60;
		light.shadowCameraRight = 60;
		light.shadowCameraBottom = 60;
		light.shadowCameraNear = 20;
		light.shadowCameraFar = 200;
		light.shadowBias = -.0001
		light.shadowMapWidth = light.shadowMapHeight = 2048;
		light.shadowDarkness = .7;
		scene.add( light );

		// Loader
		loader = new THREE.TextureLoader();

		loadSounds();

		// Ground
		createGround();

		start();

		//spawnBox();
		spawnPlayer();

		requestAnimationFrame( render );
		scene.simulate();
	};

	createGround = function() {
		ground_material = Physijs.createMaterial(
			new THREE.MeshLambertMaterial({ map: loader.load( 'images/rocks.jpg' ) }),
			.9, // high friction
			.1 // low restitution
		);
		ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
		ground_material.map.repeat.set( 3*4, 3 );

		ground = new Physijs.BoxMesh(
			new THREE.BoxGeometry(400, 1, 100),
			ground_material,
			0 // mass
		);
		ground.receiveShadow = true;
		scene.add( ground );
	}

	spawnBox = function() {
		var box_geometry = new THREE.BoxGeometry( 4, 4, 4 ),
			handleCollision = function( collided_with, linearVelocity, angularVelocity ) {
				switch ( ++this.collisions ) {

					case 1:
						this.material.color.setHex(0xcc8855);
						break;

					case 2:
						this.material.color.setHex(0xcc8855);
						break;

					case 3:
						this.material.color.setHex(0x88cc55);
						break;

					case 4:
						this.material.color.setHex(0x77dd55);
						break;

					case 5:
						this.material.color.setHex(0x99ee55);
						break;

					case 6:
						this.material.color.setHex(0x88ff55);
						break;

					case 7:
						this.material.color.setHex(0xaaff55);
						break;
				}
			},
			createBox = function() {
				var box, material;

				material = Physijs.createMaterial(
					new THREE.MeshLambertMaterial({ map: loader.load( 'images/plywood.jpg' ) }),
					.6, // medium friction
					.3 // low restitution
				);
				material.map.wrapS = material.map.wrapT = THREE.RepeatWrapping;
				material.map.repeat.set( .5, .5 );

				//material = new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'images/rocks.jpg' ) });

				box = new Physijs.BoxMesh(
					box_geometry,
					material,
					0
				);
				box.collisions = 0;
				box.name = "box";
				box.setCcdMotionThreshold(1);
				box.setCcdSweptSphereRadius(1);

				var x = Math.random() * 400 - 200;
				box.position.set(
					x,
					2.6,
					-45
				);

				box.castShadow = true;
				box.addEventListener( 'collision', handleCollision );
				//box.addEventListener( 'ready', spawnBox );
				_boxes.push( box );
				scene.add( box );
			};

		// return function() {
		// 	//setTimeout( createBox, 1000 );
			createBox();
		// };
	};

	createButton = function( x, y, z ) {
		var button_geometry = new THREE.BoxGeometry( 4, 4, 4 ),
			createButton = function() {
				var button, material;

				material = Physijs.createMaterial(
					new THREE.MeshLambertMaterial({ map: loader.load( 'images/rocks.jpg' ) }),
					.6, // medium friction
					.3 // low restitution
				);
				material.map.wrapS = material.map.wrapT = THREE.RepeatWrapping;
				material.map.repeat.set( .5, .5 );

				//material = new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'images/rocks.jpg' ) });

				button = new Physijs.BoxMesh(
					button_geometry,
					material,
					0
				);
				button.collisions = 0;
				button.name = "button";

				button.position.set( x, y, z );

				button.castShadow = true;
				scene.add( button );
			};

			createButton();
	};

	spawnPlayer = (function() {
		var box_geometry = new THREE.BoxGeometry( 4, 4, 4 ),
			handleCollision = function( collided_with, linearVelocity, angularVelocity ) {
				console.log("Player Collision!");
				switch ( ++this.collisions ) {

					// skip 1 for touching the ground
					case 2:
						this.material.color.setHex(0x779900);
						break;
					case 3:
						this.material.color.setHex(0xbb5500);
						GAMESTATE = "GAMEOVER";
						break;
				}
			},
			createBox = function() {
				var box, material;

				material = Physijs.createMaterial(
					new THREE.MeshLambertMaterial({ map: loader.load( 'images/plywood.jpg' ) }),
					.8, // medium friction
					.1 // low restitution
				);
				material.map.wrapS = material.map.wrapT = THREE.RepeatWrapping;
				material.map.repeat.set( .5, .5 );

				//material = new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'images/rocks.jpg' ) });

				box = new Physijs.BoxMesh(
					box_geometry,
					material
				);
				box.collisions = 0;
				box.name = "box";

				box.position.set( 0, 2.5, playerStartZ );

				box.castShadow = true;
				box.addEventListener( 'collision', handleCollision );
				player = box;
				scene.add( box );

				var constraint = new Physijs.HingeConstraint(
					box,
					null,
					new THREE.Vector3( 0, 2.5, playerStartZ ),
					new THREE.Vector3( 0, 1, 0 )
				);
				// scene.addConstraint( constraint );
				// constraint.setLimits(
				// 	0,
				// 	Math.pi * 2,
				// 	1.0,
				// 	0.0
				// );
			};

		return function() {
			createBox();
		};
	})();

	Update = function() {
		switch (GAMESTATE) {
			case "PLAY":
				time++;
				document.getElementById("score").innerHTML = "SCORE : " + time;
				document.getElementById("debug").innerHTML = "X["+player.position.x+"] Y["+player.position.y+"] Z["+player.position.z+"]";
		    var clampedRotation = Math.max(-100, Math.min(100, mouseX * -0.1));

				player.rotation.set( 0, clampedRotation * 0.01, 0);
				player.position.x = 0;
				player.position.y = 2.5;
				player.position.z = 25;
				player.__dirtyPosition = true;

				if (time % spawnInterval == 0)
					spawnBox();

				//  update spawn interval
				if (time % rampTime == 0)
				{
					gameSpeed += 0.1;
				}

				var box;
				for (box of _boxes) {
					box.position.z += gameSpeed;
					box.__dirtyPosition = true;

					if (box.position.z > playerStartZ + 20) {
		        var index = _boxes.indexOf( box );
		        scene.remove( _boxes[index] );
						_boxes.splice(index, 1);
					}
					else {
			      var clampedMovement = Math.max(-100, Math.min(100, mouseX * -0.1));
			      var x = clampedMovement * 36;
			      box.position.x += x * playerSpeed;
						box.__dirtyPosition = true;
					}
				}
				break;

			case "GAMEOVER":
				if (music.isEnded() == false)
				{
					music.stop();
					gameover_noise.play();
					setTimeout( function(){
						gameover.play();
					}, 700 );
				}
				GAMESTATE = "RETRY";
				break;
			case "RETRY":
				break;
		}

	};

	render = function() {
		requestAnimationFrame( render );
		renderer.render( scene, camera );
		render_stats.update();
	};

	onMouseMove = function() {
		mouseX = event.clientX - windowHalfX;
		mouseY = event.clientY - windowHalfY;

    //var clampedRotation = Math.max(-100, Math.min(100, mouseX * -0.1));

		//player.rotation.set( 0, clampedRotation * 0.01, 0);
	}

	loadSounds = function() {
		explode = new buzz.sound("sounds/Explosion.mp3");
		music = new buzz.sound("sounds/Ouroboros.mp3");
		gameover = new buzz.sound("sounds/gameover.wav");
		gameover_noise = new buzz.sound("sounds/gameover_noise.wav");
	};

	window.onload = initScene;

	</script>
</head>

<body>
	<div id="heading">
		<h1>[+]   B L O C A D E   |   R U N N E R   [+]</h1>
		<p id="score"></p>
		<p id="debug"></p>
	</div>
	<div id="viewport"></div>
</body>

</html>
